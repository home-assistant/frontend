<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../bower_components/iron-icon/iron-icon.html'>
<link rel='import' href='../components/ha-card.html'>

<link rel='import' href='../util/hass-mixins.html'>

<dom-module id='ha-weather-card'>
  <template>
    <style>
      .content {
        padding: 0 16px 16px;
      }

      iron-icon {
        color: var(--paper-item-icon-color);
      }

      .flex {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
      }

      .now iron-icon,
      .now div,
      .attributes div,
      .forecast div {
        flex: 1;
      }

      .now .state {
        --iron-icon-height: 48px;
        --iron-icon-width: 48px;
        font-size: 32px;
        text-transform: capitalize;
      }

      .now .temp {
        font-size: 48px;
        text-align: right;
      }

      .attributes,
      .forecast {
        margin-top: 24px;
      }

      .attribute {
        min-width: calc(50% - 16px);
      }

      .icon-container {
        width: 50%;
        margin-right: 8px;
        text-align: center;
      }

      .weekday,
      .temp,
      .templow {
        text-align: center;
      }

      .attributes iron-icon,
      .forecast iron-icon {
        width: 100%;
      }

      .forecast iron-icon {
        margin: 8px auto;
      }

      .weekday {
        font-weight: bold;
      }

      .templow {
        color: var(--secondary-text-color);
      }
    </style>
    <ha-card header='[[stateObj.attributes.friendly_name]]'>
      <div class='content'>
        <div class="now flex">
          <div class="state">
            <iron-icon icon="[[getWeatherIcon(stateObj.state)]]"></iron-icon>
            [[stateObj.state]]
          </div>
          <div class="temp">[[getTemperature(stateObj.attributes.temperature)]]</div>
        </div>

        <div class="attributes flex">
          <div class="attribute flex">
            <div class="icon-container">
              <iron-icon icon="mdi:water-percent"></iron-icon>
              <div>[[localize('attribute.weather.humidity')]]</div>
            </div>
            <div>[[stateObj.attributes.humidity]] %</div>
          </div>
          <div class="attribute flex">
            <div class="icon-container">
              <iron-icon icon="mdi:flag-variant"></iron-icon>
              <div>[[localize('attribute.weather.wind_speed')]]</div>
            </div>
            <div>[[getWind(stateObj.attributes.wind_speed, stateObj.attributes.wind_bearing)]]</div>
          </div>
          <div class="attribute flex">
            <div class="icon-container">
              <iron-icon icon="mdi:eye"></iron-icon>
              <div>[[localize('attribute.weather.visibility')]]</div>
            </div>
            <div>[[getVisibilty(stateObj.attributes.visibility)]]</div>
          </div>
          <div class="attribute flex">
            <div class="icon-container">
              <iron-icon icon="mdi:gauge"></iron-icon>
              <div>Pressure</div>
            </div>
            <div>[[stateObj.attributes.pressure]] hPa</div>
          </div>
        </div>

        <template is='dom-if' if='[[stateObj.attributes.forecast]]'>
          <div class="forecast flex">
            <template is='dom-repeat' items='[[stateObj.attributes.forecast]]'>
              <div>
                <div class="weekday">[[getWeekday(item.datetime)]]</div>
                <iron-icon icon="[[getWeatherIcon(item.condition)]]"></iron-icon>
                <div class="temp">[[item.temperature]]°</div>
                <div class="templow">[[item.templow]]°</div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </ha-card>
  </template>
</dom-module>

<script>
{
  const _WEATHER_TO_ICON = {
    cloudy: 'mdi:weather-cloudy',
    fog: 'mdi:weather-fog',
    hail: 'mdi:weather-hail',
    lightning: 'mid:weather-lightning',
    'lightning-rainy': 'mdi:weather-lightning-rainy',
    partlycloudy: 'mdi:weather-partlycloudy',
    pouring: 'mdi:weather-pouring',
    rainy: 'mdi:weather-rainy',
    snowy: 'mdi:weather-snowy',
    'snowy-rainy': 'weather-snowy-rainy',
    sunny: 'mdi:weather-sunny',
    windy: 'mdi:weather-windy',
    'windy-variant': 'mdi:weather-windy-variant',
    exceptional: 'mdi:help',
  };

  const _DEGREE_TEXT = [
    'N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
    'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW', 'N'
  ];
  /*
   * @appliesMixin window.hassMixins.LocalizeMixin
   */
  class HaWeatherCard extends window.hassMixins.LocalizeMixin(Polymer.Element) {
    static get is() { return 'ha-weather-card'; }
    static get properties() {
      return {
        hass: Object,
        stateObj: Object
      };
    }

    windBearingToText(degree) {
      const degreenum = parseInt(degree);
      if (isFinite(degreenum)) {
        return _DEGREE_TEXT[(((degreenum + 11.25) / 22.5) | 0) % 16];
      }
      return '';
    }

    getUnit(unit) {
      return this.hass.config.core.unit_system[unit] || '';
    }

    getWeatherIcon(weather) {
      return _WEATHER_TO_ICON[weather];
    }

    getTemperature(temp) {
      return `${temp}${this.getUnit('temperature')}`;
    }

    getWind(speed, bearing) {
      return `${speed} ${this.getUnit('length')}/h${bearing != null ? ` (${this.windBearingToText(bearing)})` : ''}`;
    }

    getVisibilty(visibilty) {
      return `${visibilty} ${this.getUnit('length')}`;
    }

    getWeekday(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString(window.navigator, { weekday: 'short' });
    }
  }
  customElements.define(HaWeatherCard.is, HaWeatherCard);
}
</script>
