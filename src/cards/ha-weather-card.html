<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../bower_components/iron-icon/iron-icon.html'>
<link rel='import' href='../components/ha-card.html'>

<link rel='import' href='../util/hass-mixins.html'>

<dom-module id='ha-weather-card'>
  <template>
    <style>
      :host {
        cursor: pointer;
      }

      .content {
        padding: 0 20px 20px;
      }

      iron-icon {
        color: var(--paper-item-icon-color);
      }

      .now {
        display: flex;
        justify-content: space-between;
      }

      .state {
        --iron-icon-height: 72px;
        --iron-icon-width: 72px;
        font-size: 52px;
      }

      .now-text {
        font-size: 24px;
      }

      .forecast {
        margin-top: 24px;
        display: flex;
        justify-content: space-between;
      }

      .forecast div {
        flex: 0 0 auto;
      }

      .forecast iron-icon {
        margin: 8px auto;
      }

      .weekday,
      .temp,
      .templow {
        text-align: center;
      }

      .weekday {
        font-weight: bold;
      }

      .attributes,
      .templow {
        color: var(--secondary-text-color);
      }
    </style>
    <ha-card header='[[stateObj.attributes.friendly_name]]'>
      <div class='content'>
        <div class="now">
          <div class="state">
            <iron-icon icon="[[getWeatherIcon(stateObj.state)]]"></iron-icon>
            [[getTemperature(stateObj.attributes.temperature)]]
          </div>
          <div class="attributes">
            <div>
              [[localize('ui.card.weather.humidity')]]:
              [[stateObj.attributes.humidity]] %
            </div>
            <div>
              [[localize('ui.card.weather.visibility')]]:
              [[getVisibilty(stateObj.attributes.visibility)]]
            </div>
            <div>
              [[localize('ui.card.weather.wind_speed')]]:
              [[getWind(stateObj.attributes.wind_speed, stateObj.attributes.wind_bearing, localize)]]
            </div>
          </div>
        </div>
        <div class="now-text">[[computeState(stateObj.state, localize)]]</div>

        <div class="forecast">
          <template is='dom-repeat' items='[[forecast]]'>
            <div>
              <div class="weekday">[[getWeekday(item.datetime)]]</div>
              <iron-icon icon="[[getWeatherIcon(item.condition)]]"></iron-icon>
              <div class="temp">[[item.temperature]]°</div>
              <div class="templow">[[item.templow]]°</div>
            </div>
          </template>
        </div>
      </div>
    </ha-card>
  </template>
</dom-module>

<script>
/*
  * @appliesMixin window.hassMixins.LocalizeMixin
  */
class HaWeatherCard extends window.hassMixins.LocalizeMixin(window.hassMixins.EventsMixin(Polymer.Element)) {
  static get is() { return 'ha-weather-card'; }
  static get properties() {
    return {
      hass: Object,
      stateObj: Object,
      forecast: {
        type: Array,
        computed: 'computeForecast(stateObj.attributes.forecast)'
      }
    };
  }

  ready() {
    this.addEventListener('click', this._onClick);
    super.ready();
  }

  _onClick() {
    this.fire('hass-more-info', { entityId: this.stateObj.entity_id });
  }

  computeForecast(forecast) {
    return forecast.slice(0, 7);
  }

  getUnit(unit) {
    return this.hass.config.core.unit_system[unit] || '';
  }

  computeState(state, localize) {
    return localize(`state.weather.${state.replace('-', '_')}`) || state;
  }

  getWeatherIcon(condition) {
    const icons = {
      'clear-night': 'mdi:weather-night',
      cloudy: 'mdi:weather-cloudy',
      fog: 'mdi:weather-fog',
      hail: 'mdi:weather-hail',
      lightning: 'mid:weather-lightning',
      'lightning-rainy': 'mdi:weather-lightning-rainy',
      partlycloudy: 'mdi:weather-partlycloudy',
      pouring: 'mdi:weather-pouring',
      rainy: 'mdi:weather-rainy',
      snowy: 'mdi:weather-snowy',
      'snowy-rainy': 'mdi:weather-snowy-rainy',
      sunny: 'mdi:weather-sunny',
      windy: 'mdi:weather-windy',
      'windy-variant': 'mdi:weather-windy-variant'
    };
    return icons[condition];
  }

  getTemperature(temp) {
    return `${temp}${this.getUnit('temperature')}`;
  }

  getWind(speed, bearing, localize) {
    if (!bearing) {
      return `${speed} ${this.getUnit('length')}/h`;
    }
    const degreeTranslation = JSON.parse(localize('ui.card.weather.wind_bearing'));
    const degreeText = degreeTranslation[(((parseInt(bearing) + 11.25) / 22.5) | 0) % 16];
    return `${speed} ${this.getUnit('length')}/h (${degreeText})`;
  }

  getVisibilty(visibilty) {
    return `${visibilty} ${this.getUnit('length')}`;
  }

  getWeekday(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(this.hass.selectedLanguage || this.hass.language, { weekday: 'short' });
  }
}
customElements.define(HaWeatherCard.is, HaWeatherCard);
</script>
