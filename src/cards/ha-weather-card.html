<link rel='import' href='../../bower_components/polymer/polymer.html'>
<link rel='import' href='../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../bower_components/google-apis/google-legacy-loader.html'>
<link rel='import' href='../components/ha-card.html'>
<dom-module id='ha-weather-card'>
  <template>
    <style>
        .content {
          padding: 0 16px 16px;
        }

        .attribution {
          color: var(--secondary-text-color);
          text-align: right;
        }
        tr.temphigh span {
          color: red;
          font-weight: 600;
        }
        tr.templow span {
          color: blue;
        }
        tr.date span {
          color: darkgrey;
          font-weight: 600;
        }
        .content td {
          text-align: center;
          vertical-align: middle;
          overflow-x: hidden;
        }
        tr.cond td {
          overflow-x: hidden;
          overflow-y: visible;
          text-align: center;
          vertical-align: middle;
          width:0%;
          height: 2.4em;
        }
        tr.cond td div {
          font-size: 2em;
          margin-left: -2em;
          transform: translateX(1em);
        }
        
        .forecast td:first-child {
          background-color: #ddd;
        }
        .forecast td:nth-child(2n+3) {
          background-color: #eee;
        }
        table, tr, td {
          border: 0;
          padding: 0;
          border-spacing: 0;
        }
        .currentcond {
          text-align: center;
          vertical-align: middle;
        }
        td.pw_small span {
          font-size: 2.4em;
        }
        td.pw_small{
          width: 25%;
          height: 2.6em;
        }
        td.pw_smallp span {
          font-size: 1.2em;
        }
        td.pw_large {
          vertical-align: middle;
          font-size: 5em;
          overflow: visible;
        }

    </style>
    <google-legacy-loader on-api-load='googleApiLoaded'></google-legacy-loader>
    <ha-card header='[[computeTitle(stateObj)]]'>
      <div class='content'>
        <table class="currentcond" width="100%">
          <tr>
            <td class="pw_small"><span>[[stateObj.attributes.temperature]]Â°</span></td>
            <td rowspan="2" class="pw_large"><span>[[nowCond]]</span></td>
            <td class="pw_small"><span>[[stateObj.attributes.humidity]]%</span></td>
          </tr>
          <tr>
            <td class="pw_smallp">
              <span>[[windBearing]]<br />[[stateObj.attributes.wind_speed]]</span>
            </td>
            <td class="pw_smallp">
              <span hidden$="[[!stateObj.attributes.visibility]]">
                Visibility<br />[[stateObj.attributes.visibility]]
              </span></td>
          </tr>
        </table><br />
        <div id='chart_id' hidden$="[[!stateObj.attributes.forecast]]"></div>
      </div>
    </ha-card>
  </template>
</dom-module>

<script>
(function () {
  'use strict';

  var _WEATHER_TO_ICON = {
    cloudy: '\u2601\ufe0f',
    fog: '\uD83C\uDF2B\ufe0f',
    hail: 'Hail',
    lightning: '\uD83C\uDF29\ufe0f',
    'lightning-rainy': '\u26c8\ufe0f',
    partlycloudy: '\u26c5\ufe0f',
    pouring: '\uD83D\uDCA7\ufe0f',
    rainy: '\uD83C\uDF27\ufe0f',
    snowy: '\uD83C\uDF28\ufe0f',
    'snowy-rainy': '\uD83C\uDF28\ufe0f',
    sunny: '\u2600\ufe0f',
    windy: '\uD83C\uDF2C\ufe0f',
    'windy-variant': '\uD83C\uDF2C\ufe0f',
    exceptional: '\u2b55\ufe0f',
  };

  var _DEGREE_TEXT = [
    'N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
    'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW', 'N'
  ];

  Polymer({
    is: 'ha-weather-card',

    properties: {
      hass: {
        type: Object,
      },

      stateObj: {
        type: Object,
        observer: 'checkRequirements'
      },
    },

    computeTitle: function (stateObj) {
      return stateObj.attributes.friendly_name;
    },
    getDataArray: function () {
      var dataArray = [];
      var data = this.stateObj.attributes.forecast;
      var i;

      if (!this.stateObj.attributes.forecast) {
        return [];
      }

      for (i = 0; i < data.length; i++) {
        var d = data[i];
        if (!d.condition) {
          dataArray.push([new Date(d.datetime), null, d.temperature, d.templow]);
        } else {
          dataArray.push([new Date(d.datetime), _WEATHER_TO_ICON[data[i].condition],
            d.temperature, d.templow]);
        }
      }

      return dataArray;
    },

    checkRequirements: function () {
      if (!this.stateObj) {
        return;
      }

      if (!window.google) {
        return;
      }

      if (!this.chartEngine) {
        this.chartEngine = new window.google.visualization.LineChart(
          this.$.chart_id);
      }

      if (!this.stateObj.attributes || !this.stateObj.attributes.forecast) {
        return;
      }

      this.nowCond = _WEATHER_TO_ICON[this.stateObj.state];
      this.windBearing = this.windBearingToText(this.stateObj.attributes.windBearing);

      this.data = this.getDataArray();

      this.drawChart();
    },
    drawChart: function () {
      var dataGrid = new window.google.visualization.DataTable();
      var options = {
        legend: {
          position: 'top'
        },
        interpolateNulls: true,
        titlePosition: 'none',
        chartArea: {
          left: 25,
          top: 5,
          height: '100%',
          width: '90%',
          bottom: 25,
        },
        curveType: 'function',
        focusTarget: 'category',
        colors: ['red', 'blue'],
        annotations: {
          textStyle: {
            fontSize: '24',
          }
        }
      };

      dataGrid.addColumn('datetime', 'Time');
      dataGrid.addColumn({ type: 'string', role: 'annotation' });
      dataGrid.addColumn('number', 'Temperature');
      dataGrid.addColumn('number', 'Temperature Low');

      var dataArray = this.getDataArray();
      dataGrid.addRows(dataArray);

      this.chartEngine.draw(dataGrid, options);
    },

    googleApiLoaded: function () {
      window.google.load('visualization', '1', {
        packages: ['corechart'],
        callback: function () {
          this.checkRequirements();
        }.bind(this),
      });
    },

    windBearingToText: function (degree) {
      return _DEGREE_TEXT[((parseInt(degree) + 5.63) / 11.25) | 0];
    }
  });
}());
</script>
