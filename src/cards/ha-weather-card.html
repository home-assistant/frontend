<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../bower_components/iron-icon/iron-icon.html'>
<link rel='import' href='../components/ha-card.html'>

<link rel='import' href='../util/hass-mixins.html'>

<dom-module id='ha-weather-card'>
  <template>
    <style>
      .content {
        padding: 0 16px 16px;
      }

      iron-icon {
        color: var(--paper-item-icon-color);
      }

      .now {
        display: flex;
        justify-content: space-between;
        padding: 0 8px;
      }

      .state {
        --iron-icon-height: 72px;
        --iron-icon-width: 72px;
        font-size: 52px;
      }

      .now-text {
        font-size: 24px;
        margin-left: 8px;
      }

      .attributes {
        color: var(--secondary-text-color);
        max-width: 200px;
      }

      .forecast {
        display: flex;
        margin-top: 24px;
      }

      .forecast div {
        flex: 1;
      }

      .forecast iron-icon {
        margin: 8px auto;
        width: 100%;
      }

      .weekday,
      .temp,
      .templow {
        text-align: center;
      }

      .weekday {
        font-weight: bold;
      }

      .templow {
        color: var(--secondary-text-color);
      }
    </style>
    <ha-card header='[[stateObj.attributes.friendly_name]]'>
      <div class='content'>
        <div class="now">
          <div class="state">
            <iron-icon icon="[[getWeatherIcon(stateObj.state)]]"></iron-icon>
            [[getTemperature(stateObj.attributes.temperature)]]
          </div>
          <div class="attributes">
            <div>
              [[localize('attribute.weather.humidity')]]: [[stateObj.attributes.humidity]] %
            </div>
            <div>
              [[localize('attribute.weather.wind_speed')]]: [[getWind(stateObj.attributes.wind_speed, stateObj.attributes.wind_bearing, localize)]]
            </div>
            <div>
              [[localize('attribute.weather.visibility')]]: [[getVisibilty(stateObj.attributes.visibility)]]
            </div>
          </div>
        </div>
        <div class="now-text">[[computeState(stateObj.state, localize)]]</div>

        <div class="forecast">
          <template is='dom-repeat' items='[[forecast]]'>
            <div>
              <div class="weekday">[[getWeekday(item.datetime)]]</div>
              <iron-icon icon="[[getWeatherIcon(item.condition)]]"></iron-icon>
              <div class="temp">[[item.temperature]]°</div>
              <div class="templow">[[item.templow]]°</div>
            </div>
          </template>
        </div>
      </div>
    </ha-card>
  </template>
</dom-module>

<script>
{
  const _WEATHER_TO_ICON = {
    'clear-night': 'mdi:weather-night',
    cloudy: 'mdi:weather-cloudy',
    fog: 'mdi:weather-fog',
    hail: 'mdi:weather-hail',
    lightning: 'mid:weather-lightning',
    'lightning-rainy': 'mdi:weather-lightning-rainy',
    partlycloudy: 'mdi:weather-partlycloudy',
    pouring: 'mdi:weather-pouring',
    rainy: 'mdi:weather-rainy',
    snowy: 'mdi:weather-snowy',
    'snowy-rainy': 'mdi:weather-snowy-rainy',
    sunny: 'mdi:weather-sunny',
    windy: 'mdi:weather-windy',
    'windy-variant': 'mdi:weather-windy-variant'
  };

  /*
   * @appliesMixin window.hassMixins.LocalizeMixin
   */
  class HaWeatherCard extends window.hassMixins.LocalizeMixin(Polymer.Element) {
    static get is() { return 'ha-weather-card'; }
    static get properties() {
      return {
        hass: Object,
        stateObj: Object,
        forecast: {
          type: Array,
          computed: 'computeForecast(stateObj.attributes.forecast)'
        }
      };
    }

    computeForecast(forecast) {
      return forecast.slice(0, 7);
    }

    getUnit(unit) {
      return this.hass.config.core.unit_system[unit] || '';
    }

    computeState(state, localize) {
      return localize(`state.weather.${state.replace('-', '_')}`) || state;
    }

    getWeatherIcon(weather) {
      return _WEATHER_TO_ICON[weather];
    }

    getTemperature(temp) {
      return `${temp}${this.getUnit('temperature')}`;
    }

    getWind(speed, bearing, localize) {
      if (!bearing) {
        return `${speed} ${this.getUnit('length')}/h`;
      }
      const degreeTranslation = JSON.parse(localize('attribute.weather.wind_bearing'));
      const degreeText = degreeTranslation[(((parseInt(bearing) + 11.25) / 22.5) | 0) % 16];
      return `${speed} ${this.getUnit('length')}/h (${degreeText})`;
    }

    getVisibilty(visibilty) {
      return `${visibilty} ${this.getUnit('length')}`;
    }

    getWeekday(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString(window.navigator, { weekday: 'short' });
    }
  }
  customElements.define(HaWeatherCard.is, HaWeatherCard);
}
</script>
