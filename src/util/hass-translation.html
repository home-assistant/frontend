<link rel='import' href='../../build-temp/translationMetadata.html' />

<script>
function getActiveTranslation() {
  // Perform case-insenstive comparison since browser isn't required to
  // report languages with specific cases.
  const lookup = {};
  /* eslint-disable no-undef */
  Object.keys(window.translationMetadata).forEach(function (tr) {
    lookup[tr.toLowerCase()] = tr;
  });

  // Search for a matching translation from most specific to general
  function languageGetTranslation(language) {
    const subtags = language.toLowerCase().split('-');

    for (var i = subtags.length; i >= 1; i--) {
      const lang = subtags.slice(0, i).join('-');

      if (lookup[lang]) {
        return lookup[lang];
      }
    }
    return null;
  }

  var translation = null;
  if (window.localStorage.selectedLanguage) {
    translation = languageGetTranslation(JSON.parse(window.localStorage.selectedLanguage));
    if (translation) {
      return translation;
    }
  } else if (navigator.languages) {
    for (var i = 0; i < navigator.languages.length; i++) {
      translation = languageGetTranslation(navigator.languages[i]);
      if (translation) {
        return translation;
      }
    }
  } else {
    translation = languageGetTranslation(navigator.language || navigator.userLanguage);
    if (translation) {
      return translation;
    }
  }

  // Final fallback
  return 'en';
}

// Store loaded translations in memory so translations are available immediately
// when DOM is created in Polymer. Even a cache lookup creates noticable latency.
const translations = {};

window.getTranslation = function (translationInput) {
  var translation = translationInput || getActiveTranslation();
  /* eslint-disable no-undef */
  var translationFingerprint = window.translationMetadata[translation].fingerprint;

  // Create a promise to fetch translation from the server
  if (!translations[translationFingerprint]) {
    translations[translationFingerprint] = new Promise(function (resolve) {
      var translationUrl = '/static/translations/' + translationFingerprint;
      var request = new XMLHttpRequest();
      request.onreadystatechange = function () {
        if (request.readyState === 4) {
          if (request.status === 200) {
            var resources = {};
            resources[translation] = JSON.parse(request.responseText);
            resolve({
              language: translation,
              resources: resources,
            });
          } else {
            /* eslint-disable no-console */
            console.error('Unable to load translation ' + translation + '. Falling back to en.');
            fallbackFetch = function () {
              delete translations[translationFingerprint];
              getTranslation('en').then(function (result) {
                resolve(result);
              });
            };
            if (translationInput !== 'en') {
              // Initial fetch failed. Try fallback to en
              fallbackFetch();
            } else {
              // Fallback fetch failed. Retry after 5 seconds
              setTimeout(fallbackFetch, 5000);
            }
          }
        }
      };
      request.open('GET', translationUrl);
      request.send();
    });
  }
  return translations[translationFingerprint];
};

// Load selected translation into memory immediately so it is ready when Polymer
// initializes.
window.getTranslation();
</script>
