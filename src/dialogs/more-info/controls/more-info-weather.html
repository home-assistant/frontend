<link rel='import' href='../../../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../../../bower_components/iron-icon/iron-icon.html'>

<link rel='import' href='../../../util/hass-mixins.html'>

<dom-module id='more-info-weather'>
  <template>
    <style>
      iron-icon {
        color: var(--paper-item-icon-color);
      }
      .section {
        margin: 16px 0 8px 0;
        font-size: 1.2em;
      }

      .flex {
        display: flex;
        height: 32px;
      }
      .main {
        flex: 1;
        margin-left: 24px;
      }

      .templow {
        margin: 0 16px;
        color: var(--secondary-text-color);
      }

      .attribution {
        color: var(--secondary-text-color);
        text-align: center;
      }
    </style>

    <div class="section">[[localize('ui.card.weather.now')]]:</div>
    <div class="flex">
      <iron-icon icon="mdi:thermometer"></iron-icon>
      <div class="main">[[localize('ui.card.weather.temperature')]]</div>
      <div>[[stateObj.attributes.temperature]] [[getUnit('temperature')]]</div>
    </div>
    <div class="flex">
      <iron-icon icon="mdi:water-percent"></iron-icon>
      <div class="main">[[localize('ui.card.weather.humidity')]]</div>
      <div>[[stateObj.attributes.humidity]] %</div>
    </div>
    <div class="flex">
      <iron-icon icon="mdi:eye"></iron-icon>
      <div class="main">[[localize('ui.card.weather.visibility')]]</div>
      <div>[[stateObj.attributes.visibility]] [[getUnit('length')]]</div>
    </div>
    <div class="flex">
      <iron-icon icon="mdi:weather-windy"></iron-icon>
      <div class="main">[[localize('ui.card.weather.wind_speed')]]</div>
      <div>[[getWind(stateObj.attributes.wind_speed, stateObj.attributes.wind_bearing, localize)]]</div>
    </div>
    <template is="dom-if" if="stateObj.attributes.pressure">
      <div class="flex">
        <iron-icon icon="mdi:gauge"></iron-icon>
        <div class="main">[[localize('ui.card.weather.air_pressure')]]</div>
        <div>[[stateObj.attributes.pressure]] hPa</div>
      </div>
    </template>

    <div class="section">[[localize('ui.card.weather.forecast')]]:</div>
    <template is='dom-repeat' items='[[stateObj.attributes.forecast]]'>
      <div class="flex">
        <iron-icon icon="[[getWeatherIcon(item.condition)]]"></iron-icon>
        <div class="main">[[computeDateString(item.datetime)]]</div>
        <div class="templow">[[item.templow]] [[getUnit('temperature')]]</div>
        <div>[[item.temperature]] [[getUnit('temperature')]]</div>
      </div>
    </template>

    <template is="dom-if" if="stateObj.attributes.attribution">
      <div class="attribution">[[stateObj.attributes.attribution]]</div>
    </template>
  </template>
</dom-module>

<script>
/*
 * @appliesMixin window.hassMixins.LocalizeMixin
 */
class MoreInfoWeather extends window.hassMixins.LocalizeMixin(Polymer.Element) {
  static get is() { return 'more-info-weather'; }

  static get properties() {
    return {
      hass: Object,
      stateObj: Object
    };
  }

  computeDateString(day) {
    const date = new Date(day);
    return date.toLocaleDateString(this.hass.selectedLanguage || this.hass.language,
      { weekday: 'long', month: 'short', day: 'numeric' });
  }

  getUnit(unit) {
    return this.hass.config.core.unit_system[unit] || '';
  }

  getWind(speed, bearing, localize) {
    if (!bearing) {
      return `${speed} ${this.getUnit('length')}/h`;
    }
    const degreeTranslation = JSON.parse(localize('ui.card.weather.wind_bearing'));
    const degreeText = degreeTranslation[(((parseInt(bearing) + 11.25) / 22.5) | 0) % 16];
    return `${speed} ${this.getUnit('length')}/h (${degreeText})`;
  }

  getWeatherIcon(condition) {
    const icons = {
      'clear-night': 'mdi:weather-night',
      cloudy: 'mdi:weather-cloudy',
      fog: 'mdi:weather-fog',
      hail: 'mdi:weather-hail',
      lightning: 'mid:weather-lightning',
      'lightning-rainy': 'mdi:weather-lightning-rainy',
      partlycloudy: 'mdi:weather-partlycloudy',
      pouring: 'mdi:weather-pouring',
      rainy: 'mdi:weather-rainy',
      snowy: 'mdi:weather-snowy',
      'snowy-rainy': 'mdi:weather-snowy-rainy',
      sunny: 'mdi:weather-sunny',
      windy: 'mdi:weather-windy',
      'windy-variant': 'mdi:weather-windy-variant'
    };
    return icons[condition];
  }
}

customElements.define(MoreInfoWeather.is, MoreInfoWeather);
</script>
