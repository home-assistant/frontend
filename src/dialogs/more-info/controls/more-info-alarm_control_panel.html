<link rel='import' href='../../../../bower_components/polymer/polymer-element.html'>
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel='import' href='../../../../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../../../../bower_components/paper-input/paper-input.html'>

<link rel='import' href='../../../../src/util/hass-mixins.html'>

<dom-module id='more-info-alarm_control_panel'>
  <template>
    <style is="custom-style" include="iron-flex"></style>
    <style>
      #codepanel {
        margin-bottom: 10%;
      }
      
      #codepanel[hidden] { display: none !important;}

     #codepanel span.spacer {
       width: 25%;
     }
    </style>

    <div class='layout horizontal center-justified'>
      <paper-input
        label='code'
        value='{{enteredCode}}'
        pattern='[[codeFormat]]'
        type='password'
        hidden$='[[!codeFormat]]'
        disabled='[[!codeInputEnabled]]'
      ></paper-input>
    </div>

    <div id='codepanel' class$='horizontal layout center-justified {{getClass(panel_locked)}}' hidden$='[[!usePinCode]]'>
      <div style='width:100%'>
        <div class='digits horizontal layout center-justified'>
          <paper-button on-click='callcode' data-digit=1 raised>1</paper-button>
          <paper-button on-click='callcode' data-digit=2 raised>2</paper-button>
          <paper-button on-click='callcode' data-digit=3 raised>3</paper-button>
        </div>
        <div class='digits horizontal layout center-justified'>
          <paper-button on-click='callcode' data-digit=4 raised>4</paper-button>
          <paper-button on-click='callcode' data-digit=5 raised>5</paper-button>
          <paper-button on-click='callcode' data-digit=6 raised>6</paper-button>
        </div>
        <div class='digits horizontal layout center-justified'>
          <paper-button on-click='callcode' data-digit=7 raised>7</paper-button>
          <paper-button on-click='callcode' data-digit=8 raised>8</paper-button>
          <paper-button on-click='callcode' data-digit=9 raised>9</paper-button>
        </div>
        <div class='digits horizontal layout center-justified'>
          <span class="spacer"></span>
          <paper-button on-click='callcode' data-digit=0 raised>0</paper-button>
          <paper-button class='clear' on-click='callclearcode' raised>Clear</paper-button>
        </div>
      </div>
    </div>

    <div class='layout horizontal'>
      <paper-button
        on-click='handleDisarmTap'
        hidden$='[[!disarmButtonVisible]]'
        disabled='[[!codeValid]]'
      >Disarm</paper-button>
      <paper-button
        on-click='handleHomeTap'
        hidden$='[[!armHomeButtonVisible]]'
        disabled=[[!codeValid]]>Arm Home</paper-button>
      <paper-button
        on-click='handleAwayTap'
        hidden$='[[!armAwayButtonVisible]]'
        disabled='[[!codeValid]]'>Arm Away</paper-button>
    </div>
  </template>
</dom-module>

<script>
class MoreInfoAlarmControlPanel extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'more-info-alarm_control_panel'; }

  static get properties() {
    return {
      hass: {
        type: Object,
      },

      stateObj: {
        type: Object,
        observer: 'stateObjChanged',
      },
      enteredCode: {
        type: String,
        value: '',
      },
      usePinCode: {
        type: Boolean,
        value: false,
      },
      disarmButtonVisible: {
        type: Boolean,
        value: false,
      },
      armHomeButtonVisible: {
        type: Boolean,
        value: false,
      },
      armAwayButtonVisible: {
        type: Boolean,
        value: false,
      },
      codeInputEnabled: {
        type: Boolean,
        value: false,
      },
      codeFormat: {
        type: String,
        value: '',
      },
      codeValid: {
        type: Boolean,
        computed: 'validateCode(enteredCode, codeFormat)',
      },
    };
  }

  validateCode(code, format) {
    var re = new RegExp(format);
    if (format === null) {
      return true;
    }
    return re.test(code);
  }

  stateObjChanged(newVal, oldVal) {
    if (newVal) {
      const pinCodeRegex = /^\[0\-9\]\{[\d]\}$/;
      const props = {
        codeFormat: newVal.attributes.code_format,
        usePinCode: newVal.attributes.code_format.match(pinCodeRegex) != null,
        armHomeButtonVisible: newVal.state === 'disarmed',
        armAwayButtonVisible: newVal.state === 'disarmed',
      };
      props.disarmButtonVisible = (
        newVal.state === 'armed_home' ||
        newVal.state === 'armed_away' ||
        newVal.state === 'armed_night' ||
        newVal.state === 'armed_custom_bypass' ||
        newVal.state === 'pending' ||
        newVal.state === 'triggered');
      props.codeInputEnabled = props.disarmButtonVisible || newVal.state === 'disarmed';
      this.setProperties(props);
    }
    if (oldVal) {
      setTimeout(() => {
        this.fire('iron-resize');
      }, 500);
    }
  }

  callcode(ev){
    ev.stopPropagation();
    var digit = ev.target.getAttribute('data-digit');
    this.enteredCode = this.enteredCode + digit;
  }
  callclearcode(ev){
    ev.stopPropagation();
    this.enteredCode = '';
  }

  handleDisarmTap() {
    this.callService('alarm_disarm', { code: this.enteredCode });
  }

  handleHomeTap() {
    this.callService('alarm_arm_home', { code: this.enteredCode });
  }

  handleAwayTap() {
    this.callService('alarm_arm_away', { code: this.enteredCode });
  }

  callService(service, data) {
    var serviceData = data || {};
    serviceData.entity_id = this.stateObj.entity_id;
    this.hass.callService('alarm_control_panel', service, serviceData)
      .then(function () {
        this.enteredCode = '';
      }.bind(this));
  }
}

customElements.define(MoreInfoAlarmControlPanel.is, MoreInfoAlarmControlPanel);
</script>
