<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../components/state-history-charts.html">
<link rel="import" href="../data/ha-state-history-data.html">
<link rel='import' href='../util/hass-mixins.html'>
<link rel='import' href='../resources/ha-style.html'>

<link rel='import' href='./more-info/more-info-controls.html'>
<link rel='import' href='./more-info/more-info-settings.html'>

<dom-module id="more-info-dialog">
  <template>
    <style include="ha-style-dialog">
      paper-dialog {
        font-size: 14px;
        width: 365px;
        border-radius: 2px;
        --paper-dialog-scrollable: {
          -webkit-overflow-scrolling: auto;
        }

        /* overrule the ha-style-dialog max-height on small screens */
        height: 100%;
        max-height: 100%;
      }

      paper-dialog[data-domain=camera] {
        width: auto;
      }

      paper-dialog[data-domain=history_graph] {
        width: 90%;
      }

      paper-dialog[data-domain=history_graph] h2 {
        display: none;
      }

      .header {
        margin-top: 0;
      }

      .header app-toolbar {
        color: #FFF;
        border-bottom: 1px solid var(--divider-color);
        background-color: var(--primary-color);
      }

      .header [main-title] {
        margin-left: 24px;
      }
    </style>

    <!-- entry-animation='slide-up-animation' exit-animation='slide-down-animation' -->
    <paper-dialog id="dialog" with-backdrop opened='{{dialogOpen}}' data-domain$='[[computeDomain(stateObj)]]'>
      <div class='header no-padding'>
        <app-toolbar>
          <paper-icon-button icon='mdi:close' dialog-dismiss></paper-icon-button>
          <div main-title>[[computeStateName(stateObj)]]</div>
          <paper-icon-button icon='[[_computeToggleIcon(_showSettings)]]' on-click='_toggleSettings'></paper-icon-button>
        </app-toolbar>
      </div>
      <template is='dom-if' if='[[!_showSettings]]'>
        <more-info-controls
          class='no-padding'
          hass='[[hass]]'
          state-obj='[[stateObj]]'
          dialog-element='[[dialogElement]]'
        ></more-info-controls>
      </template>
      <template is='dom-if' if='[[_showSettings]]'>
        <more-info-settings
          class='no-padding'
          hass='[[hass]]'
          state-obj='[[stateObj]]'
        ></more-info-settings>
      </template>
    </paper-dialog>
  </template>
</dom-module>

<script>
class MoreInfoDialog extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'more-info-dialog'; }
  static get properties() {
    return {
      hass: Object,

      stateObj: {
        type: Object,
        computed: 'computeStateObj(hass)',
        observer: 'stateObjChanged',
      },

      dialogOpen: {
        type: Boolean,
        value: false,
        observer: 'dialogOpenChanged',
      },

      delayedDialogOpen: {
        type: Boolean,
        value: false,
      },

      dialogElement: Object,

      _showSettings: {
        type: Boolean,
        value: false,
      },
    };
  }

  connectedCallback() {
    super.connectedCallback();
    this.dialogElement = this.$.dialog;
  }

  computeDomain(stateObj) {
    return stateObj ? window.hassUtil.computeDomain(stateObj) : '';
  }

  computeStateObj(hass) {
    return hass.states[hass.moreInfoEntityId] || null;
  }

  stateObjChanged(newVal) {
    if (!newVal) {
      this.dialogOpen = false;
      this._showSettings = false;
      return;
    }

    requestAnimationFrame(() => requestAnimationFrame(() => {
      // allow dialog to render content before showing it so it will be
      // positioned correctly.
      this.dialogOpen = true;
    }));
  }

  dialogOpenChanged(newVal) {
    if (newVal) {
      window.setTimeout(() => { this.delayedDialogOpen = true; }, 100);
    } else if (!newVal && this.stateObj) {
      this.fire('hass-more-info', { entityId: null });
      this.delayedDialogOpen = false;
    }
  }

  computeStateName(stateObj) {
    if (!stateObj) return '';
    return window.hassUtil.computeStateName(stateObj);
  }

  _computeToggleIcon(showSettings) {
    return showSettings ? 'mdi:tune' : 'mdi:settings';
  }

  _toggleSettings() {
    this._showSettings = !this._showSettings;
  }
}
customElements.define(MoreInfoDialog.is, MoreInfoDialog);
</script>
