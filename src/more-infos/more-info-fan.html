<link rel='import' href='../../bower_components/polymer/polymer.html'>

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel='import' href='../../bower_components/paper-slider/paper-slider.html'>
<link rel='import' href='../../bower_components/paper-menu/paper-menu.html'>
<link rel='import' href='../../bower_components/paper-item/paper-item.html'>
<link rel='import' href='../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html'>
<link rel='import' href='../../bower_components/paper-toggle-button/paper-toggle-button.html'>

<dom-module id='more-info-fan'>
  <template>
    <style is="custom-style" include="iron-flex"></style>
    <style>
      :host {
        color: var(--primary-text-color);
      }

      .container-speed_list {
        display: none;
      }

      .has-speed_list .container-speed_list{
        display: block;
      }

      .container-swing_list iron-icon {
        margin: 22px 16px 0 0;
      }

      paper-dropdown-menu {
        width: 100%;
      }

      .single-row {
        padding: 8px 0;
      }
    </style>

    <div class$='[[computeClassNames(stateObj)]]'>

      <div class='container-speed_list'
           hidden$='[[!supportsSetSpeed]]'>
        <paper-dropdown-menu label-float label='Fan Speed'>
          <paper-menu class="dropdown-content" selected="{{speedIndex}}">
            <template is='dom-repeat'
                      items='[[stateObj.attributes.speed_list]]'>
              <paper-item>[[item]]</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
      </div>

      <div class='container-oscillating'
           hidden$='[[!supportsOscillation]]'>
        <div class='center horizontal layout single-row'>
          <div class='flex'>Oscillating</div>
          <paper-toggle-button
            checked='[[oscillateToggleChecked]]'
            on-change='oscillateToggleChanged'>
          </paper-toggle-button>
        </div>
      </div>

    </div>
  </template>
</dom-module>

<script>
Polymer({
  is: 'more-info-fan',

  properties: {
    hass: {
      type: Object,
    },

    stateObj: {
      type: Object,
      observer: 'stateObjChanged',
    },

    speedIndex: {
      type: Number,
      value: -1,
      observer: 'handleSpeedChanged',
    },

    oscillateToggleChecked: {
      type: Boolean,
    },

    supportsSetSpeed: {
      type: Boolean,
      value: false,
    },

    supportsOscillation: {
      type: Boolean,
      value: false,
    },

  },

  stateObjChanged: function (newVal) {
    this.oscillateToggleChecked = newVal.attributes.oscillating;

    if (newVal.attributes.speed_list) {
      this.speedIndex = newVal.attributes.speed_list.indexOf(
        newVal.attributes.speed);
    } else {
      this.speedIndex = -1;
    }

    this.supportsSetSpeed = (newVal.attributes.supported_features & 1) !== 0;
    this.supportsOscillation = (newVal.attributes.supported_features & 2) !== 0;

    this.async(function () {
      this.fire('iron-resize');
    }.bind(this), 500);
  },

  computeClassNames: function (stateObj) {
    return 'more-info-fan' + window.hassUtil.attributeClassNames(
      stateObj,
      ['oscillate', 'speed_list']
    );
  },

  oscillateToggleChanged: function (ev) {
    var oldVal = this.stateObj.attributes.oscillating;
    var newVal = ev.target.checked;

    if (oldVal === newVal) return;

    this.callServiceHelper('oscillate', { oscillating: newVal });
  },

  handleSpeedChanged: function (speedIndex) {
    var speed;
    // Selected Option will transition to '' before transitioning to new value
    if (speedIndex === '' || speedIndex === -1) return;

    speed = this.stateObj.attributes.speed_list[speedIndex];
    if (speed === this.stateObj.attributes.fan_mode) return;

    this.callServiceHelper('set_speed', { speed: speed });
  },

  callServiceHelper: function (service, data) {
    // We call stateChanged after a successful call to re-sync the inputs
    // with the state. It will be out of sync if our service call did not
    // result in the entity to be turned on. Since the state is not changing,
    // the resync is not called automatic.
    /* eslint-disable no-param-reassign */
    data.entity_id = this.stateObj.entityId;
    /* eslint-enable no-param-reassign */
    this.hass.serviceActions.callService('fan', service, data)
      .then(function () {
        this.stateObjChanged(this.stateObj);
      }.bind(this));
  },
});
</script>
