<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../components/ha-relative-time.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/paper-time-input/paper-time-input.html">

<dom-module id="more-info-input_datetime">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <div class$='[[computeClassNames(stateObj)]]'>
      <div hidden$='[[doesNotHaveDate(stateObj)]]'>
        <vaadin-date-picker label="Date" value="{{selectedDate}}"></vaadin-date-picker>
      </div>
      <div hidden$='[[doesNotHaveTime(stateObj)]]'>
        <paper-time-input hour="{{selectedHour}}" min="{{selectedMinute}}" format="24"></paper-time-input>
      </div>
    </div>
  </template>
</dom-module>

<script>
Polymer({
  is: 'more-info-input_datetime',

  properties: {
    hass: {
      type: Object,
    },

    stateObj: {
      type: Object,
      observer: 'stateObjChanged',
    },

    selectedHour: {
      type: Number,
      value: 0,
      observer: 'dateTimeChanged',
    },

    selectedMinute: {
      type: Number,
      value: 0,
      observer: 'dateTimeChanged',
    },

    selectedDate: {
      type: String,
      value: '',
      observer: 'dateTimeChanged'
    }
  },

  doesNotHaveDate: function (stateObj) {
    return !stateObj.attributes.has_date;
  },

  doesNotHaveTime: function (stateObj) {
    return !stateObj.attributes.has_time;
  },

  getDateString: function (stateObj) {
    var monthFiller;
    if (stateObj.attributes.month < 10) {
      monthFiller = '0';
    } else {
      monthFiller = '';
    }

    var dayFiller;
    if (stateObj.attributes.day < 10) {
      dayFiller = '0';
    } else {
      dayFiller = '';
    }

    return stateObj.attributes.year + '-' + monthFiller + stateObj.attributes.month + '-' + dayFiller + stateObj.attributes.day;
  },

  dateTimeChanged: function () {
    var minuteFiller;
    if (this.selectedMinute < 10) {
      minuteFiller = '0';
    } else {
      minuteFiller = '';
    }

    var timeStr = this.selectedHour + ':' + minuteFiller + this.selectedMinute;

    var serviceData = {
      entity_id: this.stateObj.entity_id
    };

    if (this.stateObj.attributes.has_time) {
      serviceData.time = timeStr;
    }

    if (this.stateObj.attributes.has_date) {
      serviceData.date = this.selectedDate;
      if (this.selectedDate.length < 1) {
        return; // Date was not set
      }
    }

    this.hass.callService('input_datetime', 'set_datetime', serviceData);
  },

  stateObjChanged: function (newVal) {
    if (newVal.attributes.has_time) {
      this.selectedHour = newVal.attributes.hour;
      this.selectedMinute = newVal.attributes.minute;
    }

    if (newVal.attributes.has_date) {
      this.selectedDate = this.getDateString(newVal);
    }
  },

  computeClassNames: function (stateObj) {
    return 'more-info-input_datetime ' + window.hassUtil.attributeClassNames(
      stateObj, ['has_time', 'has_date']
    );
  },

});
</script>
