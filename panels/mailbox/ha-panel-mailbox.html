<link rel='import' href='../../bower_components/polymer/polymer.html'>

<link rel='import' href='../../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../../bower_components/paper-dialog/paper-dialog.html'>
<link rel='import' href='../../bower_components/paper-input/paper-textarea.html'>

<link rel='import' href='../../bower_components/app-layout/app-header-layout/app-header-layout.html'>
<link rel='import' href='../../bower_components/app-layout/app-header/app-header.html'>
<link rel='import' href='../../bower_components/app-layout/app-toolbar/app-toolbar.html'>
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel='import' href='../../src/components/ha-menu-button.html'>
<link rel='import' href='../../src/resources/ha-style.html'>

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">


<dom-module id='ha-panel-mailbox'>
  <template>
    <style include='ha-style'>
      :host {
        -ms-user-select: initial;
        -webkit-user-select: initial;
        -moz-user-select: initial;
      }

      .content {
        padding: 16px;
      }

      .ha-form {
        margin-right: 16px;
        max-width: 500px;
      }

      .header {
        @apply(--paper-font-title);
      }

      .content {
        padding: 16px;
      }

      .details {
        padding: 10px;
        margin: 10px;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14);
        font-size: 20px;
        white-space: normal;
      }
      vaadin-grid {
        height: 100%;
        max-height: 100%;
      }
      pre {
        margin: 0;
      }
    </style>

    <app-header-layout has-scrolling-region>
      <app-header slot="header" fixed>
        <app-toolbar>
          <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
          <div main-title>Mailbox</div>
        </app-toolbar>
      </app-header>
      <div class='content'>
        <div>
          <paper-button on-tap='openDeleteDialog' raised>Delete Selected</paper-button>
        </div>
        <div>
          <vaadin-grid id="msgtable" items='[[_messages]]'>
            <template class="row-details">
              <div class="details">
                [[item.message]]
              </div>
            </template>
            <vaadin-grid-selection-column auto-select>
            </vaadin-grid-selection-column>
  
            <vaadin-grid-column width="calc(30% - 100px)">
              <template class="header">Time</template>
              <template>[[item.timestamp]]</template>
            </vaadin-grid-column>
  
            <vaadin-grid-column width="calc(30% - 100px)">
              <template class="header">Caller</template>
              <template>[[item.caller]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="calc(20% - 100px">
              <template class="header">Listen</template>
              <template>
                <paper-icon-button data-sha$='[[item.sha]]' data-platform$='[[item.platform]]' icon='mdi:play-box-outline' on-tap='openMP3Dialog'></paper-icon-button>
                [[item.duration]] secs
              </template>
          </vaadin-grid>
          <paper-dialog id="mp3dialog">
            <h2>Message Plaback</h2>
            <div>
              <audio id="mp3" preload="none" controls> <source id="mp3src" src="" type="audio/mpeg"></audio>
            </div>
          </paper-dialog>
          <paper-dialog id="confirmdel">
            <h2>Delete Selected Messages</h2>
            <p>Are you sure you want to delete the selected messages?</p>
            <div class="buttons">
              <paper-button dialog-dismiss>Decline</paper-button>
              <paper-button dialog-confirm autofocus on-tap="deleteSelected">Accept</paper-button>
            </div>
          </paper-dialog>
        </div>
      </div>
    </app-header-layout>
  </template>
</dom-module>

<script>
Polymer({
  is: 'ha-panel-mailbox',

  properties: {
    hass: {
      type: Object,
    },

    narrow: {
      type: Boolean,
      value: false,
    },

    showMenu: {
      type: Boolean,
      value: false,
    },

    platforms: {
      type: Array,
    },

    _messages: {
      type: Array,
    },
  },

  attached: function () {
    this.hassChanged = this.hassChanged.bind(this);
    this.hass.connection.subscribeEvents(this.hassChanged, 'mailbox_updated')
      .then(function (unsub) { this._unsubEvents = unsub; }.bind(this));
    this.computePlatforms().then(function (platforms) {
        this.platforms = platforms;
        this.hassChanged();
    }.bind(this));
  },

  detached: function () {
    if (this._unsubEvents) this._unsubEvents();
  },

  hassChanged: function () {
    if (!this._messages) {
      this._messages = [];
    }
    this.getMessages().then(function (items) {
      this._messages = items;
      this.$.msgtable.expandedItems = items;
    }.bind(this));
  },

  openMP3Dialog: function (event) {
    var platform = event.target.dataset.platform
    this.$.mp3dialog.open();
    this.$.mp3src.src = '/api/mailbox/media/' + platform + "/" + event.target.dataset.sha;
    this.$.mp3.load();
    this.$.mp3.play();
  },

  openDeleteDialog: function () {
    this.$.confirmdel.open();
  },

  deleteSelected: function () {
    var grid = this.$.msgtable;
    var items = grid.selectedItems;
    var len = items.length;
    for (var i = 0; i < len; i++) {
      var platform = items[i].platform;
      this.hass.callApi('DELETE', 'mailbox/delete/' + platform + '/' + items[i].sha);
    }
  },
  getMessages: function () {
    let items = this.platforms.map((platform) => {
      return this.hass.callApi('GET', 'mailbox/messages/' + platform).then(function (values) {
        items = []
        var arrayLength = values.length;
        for (var i = 0; i < arrayLength; i++) {
          var datetime = window.hassUtil.formatDateTime(new Date(values[i].info.origtime * 1000));
          items.push({
            timestamp: datetime,
            caller: values[i].info.callerid,
            message: values[i].text,
            sha: values[i].sha,
            duration: values[i].info.duration,
            platform: platform
          });
        }
        return items;
      });
    });
    return Promise.all(items).then(function (items) {
      var arrayLength = items.length;
      var final = []
      for (var i = 0; i < arrayLength; i++) {
        final = final.concat(items[i]);
      }
      final.sort(function(a, b){
        return new Date(b.timestamp) - new Date(a.timestamp);
      });
      return final;
    });
  },

  computePlatforms: function (hass) {
    return this.hass.callApi('GET', 'mailbox/platforms');
  },
});

</script>
