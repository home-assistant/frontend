<link rel='import' href='../../bower_components/polymer/polymer.html'>

<link rel='import' href='../../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../../bower_components/paper-dialog/paper-dialog.html'>
<link rel='import' href='../../bower_components/paper-input/paper-textarea.html'>

<link rel='import' href='../../bower_components/app-layout/app-header-layout/app-header-layout.html'>
<link rel='import' href='../../bower_components/app-layout/app-header/app-header.html'>
<link rel='import' href='../../bower_components/app-layout/app-toolbar/app-toolbar.html'>
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel='import' href='../../src/components/ha-menu-button.html'>
<link rel='import' href='../../src/resources/ha-style.html'>

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">


<dom-module id='ha-panel-mailbox'>
  <template>
    <style include='ha-style'>
      :host {
        -ms-user-select: initial;
        -webkit-user-select: initial;
        -moz-user-select: initial;
      }

      .content {
        padding: 16px;
      }

      .ha-form {
        margin-right: 16px;
        max-width: 500px;
      }

      .description {
        margin-top: 24px;
        white-space: pre-wrap;
      }

      .header {
        @apply(--paper-font-title);
      }

      .attributes th {
        text-align: left;
      }

      .attributes tr {
        vertical-align: top;
      }

      .attributes tr:nth-child(even) {
        background-color: #eee;
      }

      .attributes td:nth-child(3) {
        white-space: pre-wrap;
        word-break: break-word;
      }

      pre {
        margin: 0;
      }
    </style>

    <app-header-layout has-scrolling-region>
      <app-header slot="header" fixed>
        <app-toolbar>
          <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
          <div main-title>Mailbox</div>
        </app-toolbar>
      </app-header>
  <div>
    <paper-button on-tap='openDeleteDialog' raised>Delete Selected</paper-button>
  </div>
  <div class="wrapper">
    <vaadin-grid id="simple" items='[[_messages]]' size="200">
      <vaadin-grid-selection-column auto-select>
      </vaadin-grid-selection-column>

      <vaadin-grid-column width="calc(15% - 100px)">
        <template class="header">Time</template>
        <template>[[item.timestamp]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column width="calc(15% - 100px)">
        <template class="header">Caller</template>
        <template>[[item.caller]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column width="calc(70% - 100px)">
        <template class="header">Message</template>
        <template>[[item.message]]</template>
      </vaadin-grid-column>
      <vaadin-grid-column width="100px" flex-grow=0>
        <template class="header">Listen</template>
        <template> <paper-icon-button data-sha$='[[item.sha]]' icon='mdi:play-box-outline' on-tap='openMP3Dialog'></paper-icon-button>[[item.duration]] secs</template>-->
        <!--<template> <audio preload="none" duration="5" controls> <source src="api/asteriskmbox/mp3/[[item.sha]]" type="audio/mpeg"></audio></template>-->
    </vaadin-grid>
    <paper-dialog id="mp3dialog">
      <h2>Message Plaback</h2>
      <div>
          <audio id="mp3" preload="none" controls> <source id="mp3src" src="" type="audio/mpeg"></audio>
      </div>
    </paper-dialog>
    <paper-dialog id="confirmdel">
      <h2>Delete Selected Messages</h2>
      <p>Are you sure you want to delete the selected messages?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Decline</paper-button>
        <paper-button dialog-confirm autofocus on-tap="deleteSelected">Accept</paper-button>
      </div>
    </paper-dialog>
  </div>

    </app-header-layout>
  </template>
</dom-module>

<script>
Polymer({
  is: 'ha-panel-mailbox',

  properties: {
    hass: {
      type: Object,
      observer: 'hassChanged'
    },

    narrow: {
      type: Boolean,
      value: false,
    },

    showMenu: {
      type: Boolean,
      value: false,
    },

    _lasUpdated: {
      type: String,
    },

    _messages: {
      type: Array,
    },
  },

  hassChanged: function (hass) {
    if (!this._messages) {
      this._messages = [];
    }
    if (!hass.states['sensor.voicemail']) {
      return;
    }
    var vm = hass.states['sensor.voicemail'];
    if (!vm.last_updated) {
      return;
    }
    var lastUpdated = vm.last_updated;
    if (!this._lastUpdated || this._lastUpdated !== lastUpdated) {
      this.getMessages().then(function (items) {
        this._messages = items;
        this._lastUpdated = lastUpdated;
      }.bind(this));
    }
  },

  openMP3Dialog: function (event) {
    this.$.mp3dialog.open();
    this.$.mp3src.src = '/api/asteriskmbox/mp3/' + event.target.dataset.sha;
    this.$.mp3.load();
    this.$.mp3.play();
  },

  openDeleteDialog: function () {
    this.$.confirmdel.open();
  },

  deleteSelected: function () {
    var grid = this.$.simple;
    var items = grid.selectedItems;
    var len = items.length;
    var sha = [];
    for (var i = 0; i < len; i++) {
      sha.push(items[i].sha);
    }
    this.hass.callApi('POST', 'asteriskmbox/delete', sha);
  },

  getMessages: function () {
    return this.hass.callApi('GET', 'asteriskmbox/messages').then(function (values) {
      var arrayLength = values.length;
      var items = [];
      for (var i = 0; i < arrayLength; i++) {
        var datetime = window.hassUtil.formatDateTime(new Date(values[i].info.origtime * 1000));
        items.push({
          timestamp: datetime,
          caller: values[i].info.callerid,
          message: values[i].text,
          sha: values[i].sha,
          duration: values[i].info.duration
        });
      }
      return items;
    });
  },
});

</script>
