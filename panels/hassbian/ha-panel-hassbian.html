<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel='import' href='../../bower_components/iron-media-query/iron-media-query.html'>
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../src/components/ha-menu-button.html">
<link rel="import" href="../../src/components/ha-card.html">
<link rel="import" href="../../src/resources/ha-style.html">

<dom-module id="ha-panel-hassbian">
  <template>
    <style include="iron-flex ha-style">
      app-header-layout {
        background-color: #fafafa;
      }

      .content {
        padding: 28px 20px 0;
        max-width: 1040px;
        margin: 0 auto;
      }

      .header {
        @apply(--paper-font-display1);
        opacity: var(--dark-primary-opacity);
      }

      .together {
        margin-top: 32px;
      }

      .intro {
        @apply(--paper-font-subhead);
        width: 100%;
        max-width: 400px;
        margin-right: 40px;
        opacity: var(--dark-primary-opacity);
      }

      .suites ha-card {
        margin-bottom: 24px;
      }

      .card-content {
        padding: 0 16px 16px;
        padding-right: 60px;
      }

      .action {
        margin-top: 8px;
        margin-left: -12px;
      }

      .state {
        margin-top: 1em;
        margin-bottom: 8px;
      }

      .spinner {
        margin-top: 16px;
      }

      paper-button {
        color: var(--default-primary-color);
        font-weight: 500;
        top: 3px;
        height: 37px;
        margin-right: -.57em;
      }

      .narrow.content {
        max-width: 640px;
      }
      .narrow .intro {
        padding-bottom: 20px;
        margin-right: 0;
      }
      .narrow .card-content {
        padding-right: 16px;
      }
    </style>
    <iron-media-query query="(min-width: 1040px)" query-matches="{{wide}}">
    </iron-media-query>
    <iron-media-query query="(min-width: 1296px)" query-matches="{{wideSidebar}}">
    </iron-media-query>

    <app-header-layout has-scrolling-region>
      <app-header fixed>
        <app-toolbar>
          <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
          <div main-title>Hassbian</div>
        </app-toolbar>
      </app-header>

      <div class$='[[computeContentClasses(isWide)]]'>
        <div class='header'>Personalize your installation</div>
        <div class$='[[computeClasses(isWide)]]'>
          <div class='intro'>
            Discover exciting add-ons to enhance your Home Assistant installation. Add an MQTT server or control a connected TV via HDMI-CEC.
          </div>
          <div class='suites flex'>
            <template is='dom-if' if='[[suiteStatus]]'>
              <template is='dom-repeat' items='[[computeSuiteKeys(suiteStatus)]]' as='suiteKey'>
                <ha-card header='[[suiteKey]]'>
                  <div class='card-content'>
                    [[computeSuiteDescription(suiteStatus, suiteKey)]]

                    <template is='dom-if' if='[[computeShowInstall(suiteStatus, suiteKey)]]'>
                      <div class='action'>
                        <paper-button on-tap='suiteActionTapped'>INSTALL</paper-button>
                      </div>
                    </template>
                    <template is='dom-if' if='[[computeShowStatus(suiteStatus, suiteKey)]]'>
                      <div class='state'>
                        [[computeSuiteStatus(suiteStatus, suiteKey)]]
                      </div>
                    </template>
                    <template is='dom-if' if='[[computeShowSpinner(suiteStatus, suiteKey)]]'>
                      <div class='spinner'>
                        <paper-spinner active></paper-spinner>
                      </div>
                    </template>
                  </div>
                </ha-card>
              </template>
            </template>
          </div>
        </div>
      </div>
    </app-header-layout>
  </template>
</dom-module>

<script>
Polymer({
  is: 'ha-panel-hassbian',

  properties: {
    hass: {
      type: Object,
    },

    narrow: {
      type: Boolean,
    },

    showMenu: {
      type: Boolean,
      value: false,
    },

    suiteStatus: {
      type: Object,
      value: null,
    },

    wide: {
      type: Boolean,
    },

    wideSidebar: {
      type: Boolean,
    },

    isWide: {
      type: Boolean,
      computed: 'computeIsWide(showMenu, wideSidebar, wide)'
    }
  },

  updateStatus: function () {
    // TODO tapping install while something is installing triggers a second
    //      update loop to start.
    this.hass.callApi('GET', 'hassbian/suites').then(function (suites) {
      this.suiteStatus = suites;

      var isInstalling = false;
      var keys = Object.keys(suites);
      for (var i = 0; i < keys.length; i++) {
        if (suites[keys[i]].state === 'installing') {
          isInstalling = true;
          break;
        }
      }

      if (isInstalling) {
        this.async(this.updateStatus, 5000);
      }
    }.bind(this));
  },

  attached: function () {
    this.updateStatus = this.updateStatus.bind(this);
    this.updateStatus();
  },

  computeIsWide: function (showMenu, wideSidebar, wide) {
    return showMenu ? wideSidebar : wide;
  },

  computeContentClasses: function (isWide) {
    var classes = 'content ';

    return isWide ? classes : classes + 'narrow'
  },

  computeClasses: function (isWide) {
    var classes = 'together layout ';

    return classes + (isWide ? 'horizontal' : 'vertical narrow');
  },

  computeSuiteKeys: function (suiteStatus) {
    // Prioritize installing packages
    return Object.keys(suiteStatus).sort(function (keyA, keyB) {
      var installingA = suiteStatus[keyA].state === 'installing';
      var installingB = suiteStatus[keyB].state === 'installing';

      if (installingA && installingB) {
        // do nothing
      } else if (installingA) {
        return -1;
      } else if (installingB) {
        return 1;
      }

      if (keyA < keyB) {
        return -1;
      }
      if (keyA > keyB) {
        return 1;
      }
      return 0;
    });
  },

  computeSuiteDescription: function (suiteStatus, suiteKey) {
    return suiteStatus[suiteKey].description;
  },

  computeSuiteStatus: function (suiteStatus, suiteKey) {
    const state = suiteStatus[suiteKey].state;
    return state.substr(0, 1).toUpperCase() + state.substr(1);
  },

  computeShowStatus: function (suiteStatus, suiteKey) {
    var state = suiteStatus[suiteKey].state;
    return state !== 'installing' && state !== 'not_installed';
  },

  computeShowInstall: function (suiteStatus, suiteKey) {
    return suiteStatus[suiteKey].state === 'not_installed';
  },

  computeShowSpinner: function (suiteStatus, suiteKey) {
    return suiteStatus[suiteKey].state === 'installing';
  },

  suiteActionTapped: function (ev) {
    this.hass.callApi('POST', 'hassbian/suites/openzwave/install').then(this.updateStatus);
  },
});
</script>
