<link rel="import" href='../../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../../bower_components/paper-dialog/paper-dialog.html'>
<link rel='import' href='../../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html'>
<link rel="import" href='../../../bower_components/paper-button/paper-button.html'>

<link rel='import' href='../../../src/util/hass-mixins.html'>
<link rel="import" href='../../../src/components/ha-markdown.html'>
<link rel='import' href='../../../src/resources/ha-style.html'>
<link rel="import" href='./ha-form.html'>

<dom-module id="ha-config-flow">
  <template>
    <style include='ha-style-dialog'>
      .error {
        color: red;
      }
      paper-dialog {
        max-width: 500px;
      }
      ha-markdown img:first-child:last-child {
        display: block;
        margin: 0 auto;
      }
    </style>
    <paper-dialog
      id='dialog'
      with-backdrop
      opened='[[flowId]]'
      on-opened-changed='_openedChanged'
    >
      <h2>
        <template is='dom-if' if='[[_equals(step.type, "abort")]]'>
          Aborted
        </template>
        <template is='dom-if' if='[[_equals(step.type, "create_entry")]]'>
          Success!
        </template>
        <template is='dom-if' if='[[_equals(step.type, "form")]]'>
          [[step.title]]
        </template>
      </h2>
      <paper-dialog-scrollable>
        <template is='dom-if' if='[[!step]]'>
          Loading flow.
        </template>
        <template is='dom-if' if='[[step]]'>
          <template is='dom-if' if='[[_equals(step.type, "abort")]]'>
            <p>[[step.reason]]</p>
          </template>

          <template is='dom-if' if='[[_equals(step.type, "create_entry")]]'>
            <p>Created config for [[step.title]]</p>
          </template>

          <template is='dom-if' if='[[_equals(step.type, "form")]]'>
            <template is='dom-if' if='[[step.description]]'>
              <ha-markdown content='[[step.description]]'></ha-markdown>
            </template>

            <template is='dom-if' if='[[step.errors.base]]'>
              <div class='error'>[[step.errors.base]]</div>
            </template>

            <ha-form
              data='{{stepData}}'
              schema='[[step.data_schema]]'
              error='[[step.errors]]'
            ></ha-form>
          </template>
        </template>
      </paper-dialog-scrollable>
      <div class='buttons'>
        <template is='dom-if' if='[[_equals(step.type, "abort")]]'>
          <paper-button on-tap='_flowDone'>Close</paper-button>
        </template>
        <template is='dom-if' if='[[_equals(step.type, "create_entry")]]'>
          <paper-button on-tap='_flowDone'>Close</paper-button>
        </template>
        <template is='dom-if' if='[[_equals(step.type, "form")]]'>
          <paper-button on-tap='_submitStep'>Submit</paper-button>
        </template>
      </div>
    </paper-dialog>
  </template>
</dom-module>

<script>
class HaConfigFlow extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'ha-config-flow'; }

  static get properties() {
    return {
      hass: Object,
      step: Object,
      flowId: {
        type: String,
        observer: '_flowIdChanged'
      },
      stepData: Object,
    };
  }

  ready() {
    super.ready();
    this.addEventListener('keypress', (ev) => {
      if (ev.keyCode === 13) {
        this._submitStep();
      }
    });
  }

  _flowIdChanged(flowId) {
    if (!flowId) return;
    this.hass.callApi('get', `config/config_entries/flow/${flowId}`)
      .then((step) => {
        this._processStep(step);
        // When the flow changes, center the dialog.
        // Don't do it on each step or else the dialog keeps bouncing.
        setTimeout(() => this.$.dialog.center(), 0);
      });
  }

  _submitStep() {
    this.hass.callApi('post', `config/config_entries/flow/${this.flowId}`, this.stepData)
      .then(step => this._processStep(step));
  }

  _processStep(step) {
    if (!step.errors) step.errors = {};
    this.step = step;
    // We got a new form if there are no errors.
    if (Object.keys(step.errors).length === 0) {
      this.stepData = {};
    }
  }

  _flowDone() {
    this.fire('flow-closed', {
      flowFinished: true
    });
  }

  _equals(a, b) {
    return a === b;
  }

  _openedChanged(ev) {
    // Closed dialog by clicking on the overlay
    if (!ev.detail.value) {
      this.fire('flow-closed', {
        flowFinished: ['success', 'abort'].includes(this.step.type)
      });
    }
  }
}

customElements.define(HaConfigFlow.is, HaConfigFlow);
</script>
