<link rel="import" href='../../../bower_components/polymer/polymer-element.html'>

<link rel="import" href='../../../bower_components/paper-input/paper-input.html'>
<link rel="import" href='../../../bower_components/paper-slider/paper-slider.html'>
<link rel="import" href='../../../bower_components/paper-checkbox/paper-checkbox.html'>
<link rel='import' href='../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html'>
<link rel='import' href='../../../bower_components/paper-listbox/paper-listbox.html'>
<link rel='import' href='../../../bower_components/paper-item/paper-item.html'>

<dom-module id="ha-form">
  <template>
    <style>
      .error {
        color: red;
      }
    </style>
    <template is='dom-if' if='[[_isArray(schema)]]' restamp>
      <template is='dom-repeat' items='[[schema]]'>
        <ha-form
          hass='[[hass]]'
          domain='[[domain]]'
          step-id='[[stepId]]'
          data='[[_getValue(data, item)]]'
          schema='[[item]]'
          error='[[_getValue(error, item)]]'
          on-data-changed='_valueChanged'
        ></ha-form>
      </template>
    </template>
    <template is='dom-if' if='[[!_isArray(schema)]]' restamp>
      <template is='dom-if' if='[[error]]'>
        <div class='error'>[[_computeError(localize, domain, error)]]</div>
      </template>

      <template is='dom-if' if='[[_equals(schema.type, "string")]]' restamp>
        <paper-input
          label='[[_computeLabel(localize, domain, stepId, schema)]]'
          value='{{data}}'
        ></paper-input>
      </template>

      <template is='dom-if' if='[[_equals(schema.type, "integer")]]' restamp>
        <template is='dom-if' if='[[_isRange(schema)]]' restamp>
          <div>
            [[_computeLabel(localize, domain, stepId, schema)]]
            <paper-slider
              pin
              value='{{data}}'
              min='[[schema.valueMin]]'
              max='[[schema.valueMax]]'
            ></paper-slider>
          </div>
        </template>
        <template is='dom-if' if='[[!_isRange(schema)]]' restamp>
          <paper-input
            label='[[_computeLabel(localize, domain, stepId, schema)]]'
            value='{{data}}'
            type='number'
          ></paper-input>
        </template>
      </template>

      <template is='dom-if' if='[[_equals(schema.type, "float")]]' restamp>
        <!--TODO-->
        <paper-input
          label='[[_computeLabel(localize, domain, stepId, schema)]]'
          value='{{data}}'
        ></paper-input>
      </template>

      <template is='dom-if' if='[[_equals(schema.type, "boolean")]]' restamp>
        <paper-checkbox
          checked='{{data}}'
        >[[_computeLabel(localize, domain, stepId, schema)]]</paper-checkbox>
      </template>

      <template is='dom-if' if='[[_equals(schema.type, "select")]]' restamp>
        <paper-dropdown-menu label='[[_computeLabel(localize, domain, stepId, schema)]]'>
          <paper-listbox
            slot="dropdown-content"
            attr-for-selected="item-name"
            selected="{{data}}"
          >
            <template is='dom-repeat'
                      items='[[schema.options]]'>
              <paper-item item-name='[[item]]'>[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </template>

    </template>
  </template>
</dom-module>

<script>
/*
 * @appliesMixin window.hassMixins.LocalizeMixin
 * @appliesMixin window.hassMixins.EventsMixin
 */
class HaForm extends
  window.hassMixins.LocalizeMixin(window.hassMixins.EventsMixin(Polymer.Element)) {
  static get is() { return 'ha-form'; }

  static get properties() {
    return {
      hass: Object,
      data: {
        type: Object,
        notify: true,
      },
      domain: String,
      stepId: String,
      schema: Object,
      error: Object,
    };
  }

  _isArray(val) {
    return Array.isArray(val);
  }

  _isRange(schema) {
    return ('valueMin' in schema) && ('valueMax' in schema);
  }

  _equals(a, b) {
    return a === b;
  }

  _getValue(obj, item) {
    return obj[item.name];
  }

  _valueChanged(ev) {
    this.set(['data', ev.model.item.name], ev.detail.value);
  }

  _computeLabel(localize, domain, stepId, schema) {
    return localize(`component.${domain}.config.step.${stepId}.data.${schema.name}`);
  }

  _computeError(localize, domain, error) {
    return localize(`component.${domain}.config.error.${error}`);
  }
}

customElements.define(HaForm.is, HaForm);
</script>
