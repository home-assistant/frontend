<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../bower_components/paper-dialog/paper-dialog.html'>
<link rel='import' href='../../bower_components/paper-checkbox/paper-checkbox.html'>
<link rel='import' href='../../bower_components/paper-button/paper-button.html'>

<dom-module id='hassio-snapshot'>
  <template>
    <style include='ha-style'>
      .content {
        width: 400px;
        padding: 16px 48px 0 48px;
      }
      iron-icon {
        float: left;
        color: var(--primary-color);
      }
      paper-checkbox {
        display: block;
        margin: 4px 8px 4px 48px;
      }
      .snapshot {
        margin-bottom: 32px;
        margin-left: 32px;
        font-size: 1.2em;
      }
      .snapshot-type {
        color: var(--secondary-text-color);
        font-size: 0.9em;
      }
      .addon-version {
        color: var(--secondary-text-color);
      }      
      .card-actions {
        border-top: 1px solid #e8e8e8;
        padding: 5px 16px;
        margin: 0;
      }
      .warning {
        color: var(--google-red-500);
      }
      .error {
        color: var(--google-red-500);
      }
      @media screen and (max-width: 600px) {
        paper-dialog {
          position: absolute !important;
          bottom: 0; left: 0; right: 0;
          border-bottom-left-radius: 0;
          border-bottom-right-radius: 0;
          margin: 0;
        }
      }
    </style>
    <paper-dialog id='dialog' with-backdrop on-iron-overlay-closed='dialogClosed'>
      <div class='content'>
        <iron-icon icon='[[computeIcon(snapshot.type)]]' class='primary'
        ></iron-icon>
        <div class='snapshot'>
          [[computeName(snapshot)]]
          <div class='snapshot-type'>
            [[computeType(snapshot.type)]] ([[computeSize(snapshot.size)]])<br/>
            [[formatDatetime(snapshot.date)]]
          </div>
        </div>
        <div>
          Home Assistant:
          <paper-checkbox checked='{{restoreHass}}'>
            Home Assistant [[snapshot.homeassistant]]
          </paper-checkbox>
        </div>
        <div>
          Folders:
          <template is='dom-repeat' items='[[snapshot.folders]]'>
            <paper-checkbox checked='{{item.checked}}'>
              [[item.name]]
            </paper-checkbox>
          </template>
        </div>
        <template is='dom-if' if='[[showAddons(snapshot.addons)]]'>
          <div>
            Add-ons:
            <template is='dom-repeat' items='[[snapshot.addons]]' sort='sortAddons'>
              <paper-checkbox checked='{{item.checked}}'>
                [[item.name]]
                <span class='addon-version'>([[item.version]])</span>
              </paper-checkbox>
            </template>
          </div>
        </template>
        <template is='dom-if' if='[[error]]'>
          <p class='error'>Error: [[error]]</p>
        </template>
      </div>
      <div class='card-actions'>
        <paper-button class='warning' on-tap='deleteTapped'>Delete</paper-button>
        <paper-button on-tap='partialRestoreTapped'>Partial restore</paper-button>
        <template is='dom-if' if='[[isFullSnapshot(snapshot.type)]]'>
          <paper-button on-tap='fullRestoreTapped'>Full restore</paper-button>
        </template>
      </div>
    </paper-dialog>
  </template>
</dom-module>

<script>
class HassioSnapshot extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'hassio-snapshot'; }

  static get properties() {
    return {
      hass: Object,
      snapshotSlug: {
        type: String,
        observer: 'computeSnapshot',
      },
      snapshot: Object,
      restoreHass: {
        type: Boolean,
        value: true,
      },
      opened: {
        type: Boolean,
        observer: 'openedChanged',
        notify: true,
      },
      updateOverview: {
        type: Boolean,
        notify: true,
      },
      error: String,
    };
  }

  computeSnapshot(snapshotSlug) {
    this.hass.callApi('get', 'hassio/snapshots/' + snapshotSlug + '/info')
      .then(function (info) {
        info.data.folders = this.computeFolders(info.data.folders);
        info.data.addons = this.computeAddons(info.data.addons);
        this.snapshot = info.data;
      }.bind(this), function () {
        this.snapshot = null;
      }.bind(this));
  }

  computeFolders(folders) {
    let list = [];
    if (folders.indexOf('homeassistant') !== -1) list.push({ slug: 'homeassistant', name: 'Home Assistant configuration', checked: true});
    if (folders.indexOf('ssl') !== -1) list.push({ slug: 'ssl', name: 'SSL', checked: true});
    if (folders.indexOf('share') !== -1) list.push({ slug: 'share', name: 'Share', checked: true});
    if (folders.indexOf('addons/local') !== -1) list.push({ slug: 'addons/local', name: 'Local add-ons', checked: true});
    return list;
  }

  computeAddons(addons) {
    for (const i in addons) {
      addons[i].checked = true;
    }
    return addons;
  }

  isFullSnapshot(type) {
    return type === 'full';
  }

  partialRestoreTapped(ev) {
    if (!confirm('Are you sure you want to restore this snapshot?')) {
      return;
    }
    const snapshot = this.snapshot;
    let addons = [];
    for (const i in snapshot.addons) {
      if (snapshot.addons[i].checked === true) addons.push(snapshot.addons[i].slug);
    }
    let folders = [];
    for (const i in snapshot.folders) {
      if (snapshot.folders[i].checked === true) folders.push(snapshot.folders[i].slug);
    }

    this.hass.callApi('post', 'hassio/snapshots/' + this.snapshotSlug + '/restore/partial', {
        homeassistant: this.restoreHass,
        addons: addons,
        folders: folders})
      .then(function () {
        alert('Snapshot restored!');
        this.$.dialog.close();
      }.bind(this), function (error) {
        this.error = error.body.message;
      }.bind(this));
  }

  fullRestoreTapped(ev) {
    if (!confirm('Are you sure you want to restore this snapshot?')) {
      return;
    }
    this.hass.callApi('post', 'hassio/snapshots/' + this.snapshotSlug + '/restore/full')
      .then(function () {
        alert('Snapshot restored!');
        this.$.dialog.close();
      }.bind(this), function (error) {
        this.error = error.body.message;
      }.bind(this));
  }

  deleteTapped(ev) {
    if (!confirm('Are you sure you want to delete this snapshot?')) {
      return;
    }
    this.hass.callApi('post', 'hassio/snapshots/' + this.snapshotSlug + '/remove')
      .then(function () {
        this.$.dialog.close();
        this.updateOverview = true;
      }.bind(this), function (error) {
        this.error = error.body.message;
      }.bind(this));
  }

  computeIcon(type) {
    return type === 'full' ? 'mdi:package-variant-closed' : 'mdi:package-variant';
  }

  showAddons(addons) {
    return addons.length === 0 ? false : true;
  }

  computeName(snapshot) {
    return snapshot.name || snapshot.slug;
  }

  computeType(type) {
    return type === 'full' ? 'Full snapshot' : 'Partial snapshot';
  }

  computeSize(size) {
    return Math.ceil(size) + ' MB';
  }

  sortAddons(a, b) {
    return a.name < b.name ? -1 : 1;
  }

  formatDatetime(datetime) {
    return new Date(datetime + '+00:00').toLocaleDateString(navigator.language, { 
      weekday: 'long',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'});
  }

  openedChanged(opened) {
    if (opened === true) this.$.dialog.open();
  }

  dialogClosed() {
    this.opened = false;
  }
}
customElements.define(HassioSnapshot.is, HassioSnapshot);
</script>
