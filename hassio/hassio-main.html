<link rel='import' href='../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../bower_components/app-route/app-route.html'>
<link rel='import' href='../bower_components/app-layout/app-header-layout/app-header-layout.html'>
<link rel='import' href='../bower_components/app-layout/app-header/app-header.html'>
<link rel='import' href='../bower_components/app-layout/app-toolbar/app-toolbar.html'>
<link rel='import' href='../bower_components/paper-icon-button/paper-icon-button.html'>
<link rel='import' href='../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../bower_components/paper-tabs/paper-tab.html'>
<link rel='import' href='../bower_components/iron-pages/iron-pages.html'>

<link rel='import' href='../src/layouts/hass-loading-screen.html'>
<link rel='import' href='../src/components/ha-menu-button.html'>

<link rel='import' href='../src/util/hass-mixins.html'>
<link rel='import' href='../src/resources/ha-style.html'>

<link rel='import' href='./hassio-api-data.html'>
<link rel='import' href='./hassio-advanced/hassio-advanced.html'>
<link rel='import' href='./hassio-addon/hassio-addon.html'>
<link rel='import' href='./hassio-dashboard/hassio-dashboard.html'>
<link rel='import' href='./hassio-snapshots/hassio-snapshots.html'>
<link rel='import' href='./hassio-store/hassio-store.html'>
<link rel='import' href='./hassio-supervisor/hassio-supervisor.html'>

<dom-module id='hassio-main'>
  <template>
    <style include='iron-flex iron-positioning ha-style'>
      paper-tabs {
        margin-left: 12px;
        --paper-tabs-selection-bar-color: #FFF;
        text-transform: uppercase;
      }
    </style>
    <app-route
      route='[[route]]'
      pattern='/:page'
      data='{{routeData}}'
    ></app-route>
    <hassio-api-data
      id='data'
      hass='[[hass]]'
      api-data='{{apiData}}'
    ></hassio-api-data>

    <template is='dom-if' if='[[!apiData]]'>
      <hass-loading-screen
        narrow='[[narrow]]'
        show-menu='[[showMenu]]'
      ></hass-loading-screen>
    </template>

    <template is='dom-if' if='[[apiData]]'>
      <app-header-layout has-scrolling-region>
        <app-header fixed slot='header'>
          <app-toolbar>            
            <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
            <paper-icon-button
              icon='mdi:arrow-left'
              on-tap='backTapped'
              hidden='[[computeHideBack(mainTitle)]]'></paper-icon-button>
            <div main-title>[[mainTitle]]</div>
          </app-toolbar>
          <paper-tabs
            scrollable
            selected='[[routeData.page]]'
            attr-for-selected='page-name'
            on-iron-activate='handlePageSelected'
          >
            <paper-tab page-name='dashboard'>Dashboard</paper-tab>
            <paper-tab page-name='store'>Add-on store</paper-tab>
            <paper-tab page-name='snapshots'>Snapshots</paper-tab>
            <paper-tab page-name='advanced'>Advanced</paper-tab>
          </paper-tabs>
        </app-header>

        <iron-pages
          selected='[[routeData.page]]'
          attr-for-selected='page-name'
          fallback-selection='not-found'
          selected-attribute='visible'
        >
          <hassio-dashboard
            page-name='dashboard'
            hass='[[hass]]'
            columns='[[_columns]]'
            api-data='[[apiData]]'
          ></hassio-dashboard>

          <hassio-store
            page-name='store'
            hass='[[hass]]'
            addons='[[apiData.addons]]'
            columns='[[_columns]]'
            repos='[[apiData.repositories]]'
          ></hassio-store>

          <hassio-snapshots
            page-name='snapshots'
            hass='[[hass]]'
            snapshots='[[apiData.snapshots]]'
            addons='[[apiData.supervisor.addons]]'
            route='[[route]]'
          ></hassio-snapshots>

          <hassio-advanced
            page-name='advanced'
            hass='[[hass]]'
            columns='[[_columns]]'
            api-data='[[apiData]]'
          ></hassio-advanced>

          <hassio-addon
            page-name='addon'
            hass='[[hass]]'
            route='[[route]]'
          ></hassio-addon>

          <hassio-supervisor
            page-name='supervisor'
            hass='[[hass]]'
          ></hassio-supervisor>

          <div
            page-name='not-found'
            class='error-page'
          >Page not found.</div>
        </iron-pages>
      </app-header-layout>
    </template>
  </template>
</dom-module>

<script>
class HassioMain extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'hassio-main'; }

  static get properties() {
    return {
      hass: Object,
      narrow: Boolean,
      showMenu: {
        type: Boolean,
        observer: 'handleWindowChange',
      },
      route: {
        type: Object,
        // Fake route object
        value: {
          prefix: '/hassio',
          path: '/dashboard',
          __queryParams: {}
        },
        observer: 'routeChanged',
      },
      routeData: Object,
      _columns: {
        type: Number,
        value: 1,
      },
      apiData: Object,
      mainTitle: {
        type: String,
        computed: 'computeTitle(route)',
      },
    };
  }

  constructor() {
    super();
    this.handleWindowChange = this.handleWindowChange.bind(this);
    this.mqls = [300, 600, 900, 1200].map(function (width) {
      var mql = window.matchMedia('(min-width: ' + width + 'px)');
      mql.addListener(this.handleWindowChange);
      return mql;
    }.bind(this));
  }

  disconnectedCallback() {
    super.disconnectedCallback();
    this.mqls.forEach((mql) => {
      mql.removeListener(this.handleWindowChange);
    });
  }

  ready() {
    super.ready();
    window.hassUtil.applyThemesOnElement(this, this.hass.themes, this.hass.selectedTheme, true);
    this.addEventListener('hass-api-called', ev => this.apiCalled(ev));
  }

  connectedCallback() {
    super.connectedCallback();
    this.routeChanged(this.route);
  }

  apiCalled(ev) {
    if (ev.detail.success) {
      var tries = 1;

      var tryUpdate = function () {
        this.$.data.refresh().catch(function () {
          tries += 1;
          setTimeout(tryUpdate, Math.min(tries, 5) * 1000);
        });
      }.bind(this);

      tryUpdate();
    }
  }

  routeChanged(route) {
    if (route.path === '' && route.prefix === '/hassio') {
      history.replaceState(null, null, '/hassio/dashboard');
      this.fire('location-changed');
    }
  }

  handlePageSelected(ev) {
    var page = ev.detail.item.getAttribute('page-name') || null;
    var current = this.routeData.page;
    if (page !== current) {
      var path = '/hassio';
      if (page) {
        path += '/' + page;
      }
      history.pushState(null, null, path);
      this.fire('location-changed');
    }
  }

  computeTitle(route) {
    return route.path.substring(0, 7) === '/addon/' ? 'Add-on details' : 'Hass.io';
  }

  handleWindowChange() {
    var matchColumns = this.mqls.reduce(function (cols, mql) {
      return cols + mql.matches;
    }, 0);
    // Do -1 column if the menu is docked and open
    this._columns = Math.max(1, matchColumns - (!this.narrow && this.showMenu));
  }

  computeHideBack(mainTitle) {
    return mainTitle === 'Hass.io';
  }

  backTapped() {
    history.back();
  }
}
customElements.define(HassioMain.is, HassioMain);
</script>
