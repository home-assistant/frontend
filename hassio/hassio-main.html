<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel='import' href='../bower_components/app-layout/app-header-layout/app-header-layout.html'>
<link rel='import' href='../bower_components/app-layout/app-header/app-header.html'>
<link rel='import' href='../bower_components/app-layout/app-toolbar/app-toolbar.html'>
<link rel='import' href='../bower_components/paper-icon-button/paper-icon-button.html'>

<link rel="import" href="../src/layouts/hass-loading-screen.html">
<link rel='import' href='../src/util/hass-util.html'>
<link rel='import' href='../src/components/ha-menu-button.html'>
<link rel='import' href='../src/resources/ha-style.html'>

<link rel='import' href='./hassio-data.html'>
<link rel='import' href='./hassio-navigation.html'>
<link rel='import' href='./hassio-pages.html'>

<dom-module id="hassio-main">
  <template>
    <style include='ha-style'></style>
    <app-route
      route='[[route]]'
      pattern='/:page'
      data="{{routeData}}"
    ></app-route>
    <hassio-data
      id='data'
      hass='[[hass]]'
      supervisor='{{supervisorInfo}}'
      homeassistant='{{hassInfo}}'
      host='{{hostInfo}}'
    ></hassio-data>

    <template is='dom-if' if='[[!loaded]]'>
      <hass-loading-screen
        narrow='[[narrow]]'
        show-menu='[[showMenu]]'
      ></hass-loading-screen>
    </template>

    <template is='dom-if' if='[[loaded]]'>
      <app-header-layout has-scrolling-region>
        <app-header fixed slot='header'>
          <app-toolbar>            
            <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
            <paper-icon-button
              icon='mdi:arrow-left'
              on-tap='backTapped'
              hidden='[[!pageIsAddon]]'
            ></paper-icon-button>
            <div main-title>[[title]]</div>
          </app-toolbar>
          <template is='dom-if' if='[[!pageIsAddon]]'>
            <hassio-navigation
              page='[[routeData.page]]'>        
            </hassio-navigation>
          </template>
        </app-header>
        <hassio-pages
          page='[[routeData.page]]'
          route='[[route]]'
          hass='[[hass]]'
          supervisor-info='[[supervisorInfo]]'
          hass-info='[[hassInfo]]'
          host-info='[[hostInfo]]'
        ></hassio-pages>
      </app-header-layout>
    </template>
  </template>
</dom-module>

<script>
class HassioMain extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'hassio-main'; }

  static get properties() {
    return {
      hass: Object,
      route: {
        type: Object,
        // Fake route object
        value: {
          prefix: '/hassio',
          path: '/dashboard',
          __queryParams: {}
        },
        observer: 'routeChanged',
      },
      routeData: {
        type: Object,
        observer: 'routeDataChanged',
      },
      supervisorInfo: Object,
      hostInfo: Object,
      hassInfo: Object,
      loaded: {
        type: Boolean,
        computed: 'computeIsLoaded(supervisorInfo, hostInfo, hassInfo)',
      },
      narrow: Boolean,
      showMenu: Boolean,
      pageIsAddon: Boolean,
      title: String,
    };
  }

  ready() {
    super.ready();
    window.hassUtil.applyThemesOnElement(this, this.hass.themes, this.hass.selectedTheme, true);
    this.addEventListener('hass-api-called', ev => this.apiCalled(ev));
  }

  connectedCallback() {
    super.connectedCallback();
    this.routeChanged(this.route);
  }

  apiCalled(ev) {
    if (ev.detail.success) {
      let tries = 1;

      const tryUpdate = () => {
        this.$.data.refresh().catch(function () {
          tries += 1;
          setTimeout(tryUpdate, Math.min(tries, 5) * 1000);
        });
      };

      tryUpdate();
    }
  }

  computeIsLoaded(supervisorInfo, hostInfo, hassInfo) {
    return (supervisorInfo !== null &&
            hostInfo !== null &&
            hassInfo !== null);
  }

  routeChanged(route) {
    if (route.path === '' && route.prefix === '/hassio') {
      history.replaceState(null, null, '/hassio/dashboard');
      this.fire('location-changed');
    }
  }

  routeDataChanged(routeData) {
    if (routeData.page && routeData.page === 'addon') {
      this.pageIsAddon = true;
      this.title = 'Hass.io: add-on details';
    } else {
      this.pageIsAddon = false;
      this.title = 'Hass.io';
    }
  }

  backTapped() {
    history.back();
  }
}

customElements.define(HassioMain.is, HassioMain);
</script>
