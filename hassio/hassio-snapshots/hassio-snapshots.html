<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel='import' href='../../bower_components/paper-card/paper-card.html'>
<link rel='import' href='../../bower_components/paper-input/paper-input.html'>
<link rel='import' href='../../bower_components/iron-collapse/iron-collapse.html'>
<link rel='import' href='../../bower_components/paper-radio-group/paper-radio-group.html'>
<link rel='import' href='../../bower_components/paper-radio-button/paper-radio-button.html'>
<link rel='import' href='../../bower_components/paper-checkbox/paper-checkbox.html'>
<link rel='import' href='../../bower_components/paper-dialog/paper-dialog.html'>

<link rel='import' href='./hassio-snapshots-details.html'>

<link rel='import' href='../components/hassio-item-info.html'>
<link rel='import' href='../hassio-style.html'>

<dom-module id='hassio-snapshots'>
  <template>
    <style include='hassio-style'></style>
    <style include='iron-flex ha-style'>
      paper-checkbox {
        display: block;
        margin: 4px 0 4px 48px;
      }
      .pointer {
        cursor: pointer;
      }
      paper-dialog#details {
        padding: 0 16px;
      }
    </style>
    <div class='content'>
      <div class='card-group'>
        <div class='title'>
          Create a new snapshot
          <div class='description'>
            Snapshots allow you to easily backup and restore all data of your Hass.io instance.
          </div>
        </div>
        <paper-card>
          <div class='card-content'>
            <paper-input label='Name' value='{{_name}}'></paper-input>
            <label id='lbltype'>Type:</label>
            <paper-radio-group selected='{{_type}}' aria-labelledby='lbltype' on-paper-radio-group-changed='typeChanged'>
              <paper-radio-button name='full'>Full snapshot</paper-radio-button>
              <paper-radio-button name='partial'>Partial snapshot</paper-radio-button>
            </paper-radio-group>
            <iron-collapse id="snapshot_folders">Folders:
              <template is='dom-repeat' items='[[_folders]]'>
                <paper-checkbox checked='{{item.checked}}' on-change='checkboxChanged'>[[item.name]]</paper-checkbox>
              </template>
            </iron-collapse>
            <iron-collapse id="snapshot_addons">Add-ons:
              <template is='dom-repeat' items='[[_addons]]' sort='sortAddons'>
                <paper-checkbox checked='{{item.checked}}' on-change='checkboxChanged'>[[item.name]]</paper-checkbox>
              </template>
            </iron-collapse>
          </div>
          <div class='card-actions'>
            <paper-button
              disabled='[[operationInProgress]]'
              on-tap='createSnapshot'
            >Create</paper-button>
            <template is='dom-if' if='[[error]]'>
              <p class='error'>[[error]]</p>
            </template>
          </div>
        </paper-card>
      </div>

      <div class='card-group'>
        <div class='title'>Available snapshots</div>
        <template is='dom-if' if='[[!snapshots.length]]'>
          <paper-card>
            <div class='card-content'>You don't have any snapshots yet.</div>
          </paper-card>
        </template>
        <template is='dom-repeat' items='[[snapshots]]' as='snapshot' sort='sortSnapshots'>
          <paper-card class='pointer' on-click='snapshotTapped'>
            <div class='card-content'>
              <hassio-item-info
                title='[[computeName(snapshot)]]'
                description='[[snapshot.date]]Z'
                datetime
                icon='[[computeIcon(snapshot.type)]]'
                icon-class='primary'
              ></hassio-item-info>
            </div>
          </paper-card>
        </template>
      </div>
    </div>

    <paper-dialog id='details'>
      <hassio-snapshots-details
        hass='[[hass]]'
        snapshot-slug='[[selectedSnapshot]]'
      ></hassio-snapshots-details>
    </paper-dialog>
  </template>
</dom-module>

<script>
class HassioSnapshots extends window.hassMixins.EventsMixin(Polymer.Element) {
  static get is() { return 'hassio-snapshots'; }

  static get properties() {
    return {
      hass: Object,
      snapshots: Array,
      addons: Array,

      _name: String,
      _type : {
        type: String,
        value: 'full',
      },
      _addons: {
        type: Array,
        computed: 'computeAddons(addons)',
      },
      _folders: {
        type: Array,
        value : [
          { slug: 'homeassistant', name: 'Home Assistant configuration', checked: true},
          { slug: 'ssl', name: 'SSL', checked: true},
          { slug: 'share', name: 'Share', checked: true},
          { slug: 'addons/local', name: 'Local add-ons', checked: true},
        ],
      },
      selectedSnapshot: String,
      operationInProgress: Boolean,
      error: String,
    };
  }

  computeAddons(addons) {
    var list = [];
    for (const i in addons) {
      list.push({ slug: addons[i].slug, name: addons[i].name, checked: true});
    }
    return list;
  }

  ready() {
    super.ready();
    this.addEventListener('hass-api-called', ev => this.apiCalled(ev));
  }

  apiCalled(ev) {
    if (ev.detail.success) {
      this.updateData();
    }
  }

  updateData() {
    this.hass.callApi('get', 'hassio/snapshots')
      .then(function (result) {
        this.snapshots = result.data.snapshots;
      }.bind(this), function (error) {
        this.error = error.message;
      }.bind(this));
  }

  createSnapshot() {
    this.operationInProgress = true;
    var name = this._name;
    if (!name || name.length === 0) {
      name = (new Date).toLocaleDateString(navigator.language, { 
        weekday: 'long',
        year: 'numeric',
        month: 'short',
        day: 'numeric' });
    }
    if (this._type === 'full') {
      var data = { name: this._name };
      var path = 'hassio/snapshots/new/full';
    } else {
      var _folders = this._folders;
      var folders = [];
      for (const i in this._folders) {
        if (_folders[i].checked === true) folders.push(_folders[i].slug);
      }
      var _addons = this._addons;
      var addons = [];
      for (const i in _addons) {
        if (_addons[i].checked === true) addons.push(_addons[i].slug);
      }
      var data = { name: name, folders: folders, addons: addons };
      var path = 'hassio/snapshots/new/partial';
    }

    this.hass.callApi('post', path, data)
      .then(function () {
        this.operationInProgress = false;
        this.fire('hass-api-called', { success: true });
      }.bind(this), function (error) {
        this.operationInProgress = false;
        this.error = error.message;
      }.bind(this));
  }

  sortAddons(a, b) {
    return a.name < b.name ? -1 : 1;
  }

  sortSnapshots(a, b) {
    return a.date < b.date ? 1 : -1;
  }

  computeName(snapshot) {
    return snapshot.name || snapshot.slug;
  }

  snapshotTapped(ev) {
    this.selectedSnapshot = ev.model.snapshot.slug;
    this.root.getElementById('details').open();
  }

  computeIcon(type) {
    return type === 'full' ? 'mdi:package-variant' : 'mdi:folder-open';
  }

  typeChanged() {
    if (this._type === 'full') {
      this.$.snapshot_folders.hide();
      this.$.snapshot_addons.hide();
      for (const i in this._folders) {
        this._folders[i].checked = true;
        this.notifyPath('_folders.' + i + '.checked');
      }
      for (const i in this._addons) {
        this._addons[i].checked = true;
        this.notifyPath('_addons.' + i + '.checked');
      }
    }
    else {
      this.$.snapshot_folders.show();
      this.$.snapshot_addons.show();
    }
  }

  checkboxChanged(ev) {
    if (ev.model.item.checked === false) this._type = 'partial';
  }
}
customElements.define(HassioSnapshots.is, HassioSnapshots);
</script>
