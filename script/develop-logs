#!/bin/sh
# Run the logs frontend development server

# Stop on errors
set -e

cd "$(dirname "$0")/.."

# Parse command line arguments
SUPERVISOR_ENDPOINT=""
SUPERVISOR_API_TOKEN=""

while getopts "c:t:h" opt; do
  case $opt in
    c)
      SUPERVISOR_ENDPOINT="$OPTARG"
      ;;
    t)
      SUPERVISOR_API_TOKEN="$OPTARG"
      ;;
    h)
      echo "Usage: $0 -c SUPERVISOR_ENDPOINT -t SUPERVISOR_API_TOKEN"
      echo ""
      echo "Options:"
      echo "  -c  SUPERVISOR_ENDPOINT (e.g., http://192.168.1.2) [required]"
      echo "  -t  SUPERVISOR_API_TOKEN (from remote_api add-on) [required]"
      echo "  -h  Show this help message"
      echo ""
      echo "Example:"
      echo "  $0 -c http://192.168.1.2 -t your_token_here"
      exit 0
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      echo "Use -h for help"
      exit 1
      ;;
  esac
done

# Validate that both -c and -t are provided
if [ -z "$SUPERVISOR_ENDPOINT" ] || [ -z "$SUPERVISOR_API_TOKEN" ]; then
  echo "Error: Both -c and -t are required" >&2
  echo "Use -h for help"
  exit 1
fi

# Cleanup function
cleanup() {
  echo ""
  echo "Shutting down..."
  echo "Stopping HA CLI container..."
  docker stop ha-cli-dev 2>/dev/null || true
  exit 0
}

# Set up trap to cleanup on exit
trap cleanup INT TERM EXIT

# Run HA CLI container
echo "Starting HA CLI container..."

# Build the container if needed
if ! docker images | grep -q "ha-cli:local"; then
  echo "Building HA CLI container..."
  (cd logs && docker compose build)
fi

# Clean up any existing container
docker stop ha-cli-dev 2>/dev/null || true

# Run the container in background (not detached, so it shares stdout)
docker run \
  --name ha-cli-dev \
  --rm \
  -p 5642:5642 \
  -e SUPERVISOR_ENDPOINT="$SUPERVISOR_ENDPOINT" \
  -e SUPERVISOR_API_TOKEN="$SUPERVISOR_API_TOKEN" \
  -e PORT=5642 \
  ha-cli:local &

# Store the docker process ID
DOCKER_PID=$!

# Wait a moment for container to start
sleep 2
echo ""
echo "HA Logs Backend API: http://localhost:5642"
echo "  GET  /api/logs - List endpoints"
echo "  GET  /api/logs/core - Core logs"
echo "  GET  /api/logs/supervisor - Supervisor logs"
echo "  GET  /health - Health check"
echo ""

# Run gulp (this will block until Ctrl+C)
./node_modules/.bin/gulp develop-logs
